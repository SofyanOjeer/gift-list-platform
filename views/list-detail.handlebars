<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>{{list.name}}</h1>
        <p class="text-muted">{{list.description}}</p>
        <div>
            <span class="badge bg-primary">{{list.views}} vues</span>
            {{#if (eq list.visibility 'public')}}
                <span class="badge bg-success">Public</span>
            {{else if (eq list.visibility 'private')}}
                <span class="badge bg-warning">Priv√©</span>
            {{else}}
                <span class="badge bg-secondary">Non list√©</span>
            {{/if}}
        </div>
    </div>
    <div>
        {{#if isOwner}}
            <a href="/stats/list/{{list.id}}" class="btn btn-outline-info me-2">
                <i class="fas fa-chart-bar me-2"></i>Statistiques
            </a>
            <!-- BOUTON PRINCIPAL TOUJOURS VISIBLE -->
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                <i class="fas fa-plus me-1"></i>Ajouter un article
            </button>
        {{/if}}
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-gifts me-2"></i>Articles ({{items.length}})</h5>
                {{#if isOwner}}
                    <!-- BOUTON SECONDAIRE DANS L'EN-T√äTE -->
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addItemModal">
                        <i class="fas fa-plus me-1"></i>Nouvel article
                    </button>
                {{/if}}
            </div>
            <div class="card-body">
                {{#if items.length}}
                    {{#each items}}
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row">
                                    {{#if this.image}}
                                    <div class="col-md-3">
                                        <img src="{{this.image}}" alt="{{this.name}}" class="img-fluid rounded" style="max-height: 150px; object-fit: cover;">
                                    </div>
                                    {{/if}}
                                    <div class="{{#if this.image}}col-md-9{{else}}col-12{{/if}}">
                                        <h5 class="card-title">{{this.name}}</h5>
                                        <p class="card-text">{{this.description}}</p>
                                        
                                        <div class="row mb-2">
                                            {{#if ../list.show_prices}}
                                            <div class="col">
                                                <strong>Prix:</strong> {{formatPrice this.price}}
                                            </div>
                                            {{/if}}
                                            <div class="col">
                                                {{#if ../isOwner}}
                                                    <strong>Quantit√©:</strong> {{this.quantity}} disponible(s)
                                                {{else}}
                                                    <strong>Quantit√©:</strong> 
                                                    <span class="quantity-display">{{this.reserved_quantity}}/{{this.quantity}} r√©serv√©(s)</span>
                                                {{/if}}
                                            </div>
                                        </div>
                                        
                                        {{#if this.url}}
                                        <div class="mb-2">
                                            <a href="{{this.url}}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-external-link-alt me-1"></i>Voir le produit
                                            </a>
                                        </div>
                                        {{/if}}
                                        
                                        {{#unless ../isOwner}}
                                            {{#if (gt this.quantity this.reserved_quantity)}}
                                            <button class="btn btn-success btn-sm reserve-btn" 
                                                    data-item-id="{{this.id}}"
                                                    data-item-name="{{this.name}}"
                                                    data-max-quantity="{{subtract this.quantity this.reserved_quantity}}"
                                                    data-total-quantity="{{this.quantity}}"
                                                    data-user-email="{{../user.email}}">
                                                <i class="fas fa-shopping-cart me-1"></i>R√©server
                                            </button>
                                            {{else}}
                                            <span class="badge bg-secondary">Complet</span>
                                            {{/if}}
                                        {{/unless}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {{/each}}
                {{else}}
                    <div class="text-center py-4">
                        <i class="fas fa-gift fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Aucun article dans cette liste</p>
                        {{#if isOwner}}
                            <!-- BOUTON DANS L'√âTAT VIDE -->
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                                <i class="fas fa-plus me-1"></i>Ajouter le premier article
                            </button>
                        {{/if}}
                    </div>
                {{/if}}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations</h5>
            </div>
            <div class="card-body">
                <p><strong>Cr√©√©e par:</strong> {{list.creator_username}}</p>
                <p><strong>Visibilit√©:</strong> 
                    {{#if (eq list.visibility 'public')}}
                        üåç Public - <small class="text-muted">Visible sur le profil</small>
                    {{else}}
                        üîí Priv√©e - <small class="text-muted">Acc√®s par lien seulement</small>
                    {{/if}}
                </p>
                
                {{#if isOwner}}
                    <div class="mb-3">
                        <label class="form-label"><strong>Partager cette liste:</strong></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="shareLink" 
                                   value="{{../baseUrl}}/lists/{{list.id}}" readonly>
                            <button id="copyShareBtn" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-link me-1"></i> Copier le lien
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Partagez ce lien pour donner acc√®s √† votre liste
                        </small>
                    </div>
                    {{#eq list.visibility 'private'}}
                    <div class="mb-3">
                        <a href="/lists/{{list.id}}/members" class="btn btn-outline-primary btn-sm">
                            üë• G√©rer les membres
                        </a>
                    </div>
                    {{/eq}}
                {{else}}
                    {{#if userFollowsList}}
                        <button class="btn btn-outline-danger w-100 unfollow-btn" 
                                data-list-id="{{list.id}}"
                                data-list-name="{{list.name}}">
                            <i class="fas fa-times me-2"></i>Ne plus suivre
                        </button>
                    {{else}}
                        <button class="btn btn-outline-primary w-100 follow-btn" data-list-id="{{list.id}}">
                            <i class="fas fa-heart me-2"></i>Suivre cette liste
                        </button>
                    {{/if}}
                {{/if}}
            </div>
        </div>
    </div>
</div>

{{#if isOwner}}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Information</h5>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-gift fa-2x text-success mb-3"></i>
                <p class="mb-0">
                    <strong>La surprise est pr√©serv√©e !</strong><br>
                    Vous ne verrez pas qui a r√©serv√© vos articles ni les quantit√©s r√©serv√©es.<br>
                    Les r√©servations sont anonymes par d√©faut pour une vraie surprise üéÅ
                </p>
            </div>
        </div>
    </div>
</div>
{{/if}}

<!-- Modal pour ajouter un item -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un article</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addItemForm" action="/items/{{list.id}}" method="POST">
                    <!-- URL avec extraction automatique -->
                    <div class="mb-3">
                        <label for="itemUrl" class="form-label">
                            <i class="fas fa-link me-1"></i>URL du produit
                        </label>
                        <div class="input-group">
                            <input type="url" class="form-control" id="itemUrl" 
                                   name="url" placeholder="https://..." 
                                   pattern="https?://.+" required>
                            <button type="button" class="btn btn-outline-primary" id="extractInfoBtn">
                                <i class="fas fa-magic me-1"></i>Extraire
                            </button>
                        </div>
                        <div class="form-text">
                            Collez l'URL du produit pour extraire automatiquement les informations
                        </div>
                    </div>

                    <!-- Indicateur de chargement -->
                    <div id="extractionLoading" class="alert alert-info d-none">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Extraction des informations en cours...
                    </div>

                    <!-- R√©sultat de l'extraction -->
                    <div id="extractionResult" class="card d-none mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <img id="extractedImage" src="" class="img-fluid rounded" 
                                         style="max-height: 100px; object-fit: cover;">
                                </div>
                                <div class="col-md-9">
                                    <h6 id="extractedTitle" class="card-title"></h6>
                                    <p id="extractedDescription" class="card-text small text-muted"></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span id="extractedPrice" class="fw-bold text-primary"></span>
                                        <small class="text-success">
                                            <i class="fas fa-check me-1"></i>Informations extraites
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Champs du formulaire -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="itemName" class="form-label">Nom de l'article</label>
                                <input type="text" class="form-control" id="itemName" name="name" required>
                            </div>
                        </div>
<div class="col-md-4">
    <div class="mb-3">
        <label for="itemPrice" class="form-label">Prix (‚Ç¨)</label>
        <input type="text" class="form-control" id="itemPrice" name="price" 
               placeholder="0,00" pattern="[0-9]+([,][0-9]{1,2})?">
        <small class="form-text text-muted">Utilisez une virgule pour les d√©cimales</small>
    </div>
</div>
                    </div>

                    <div class="mb-3">
                        <label for="itemDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="itemDescription" name="description" 
                                  rows="3" placeholder="Description optionnelle..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="itemImage" class="form-label">Image URL</label>
                                <input type="url" class="form-control" id="itemImage" name="image" 
                                       placeholder="https://...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="itemQuantity" class="form-label">Quantit√©</label>
                                <input type="number" class="form-control" id="itemQuantity" name="quantity" 
                                       value="1" min="1" max="100">
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Ajouter l'article
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<body data-is-owner="{{isOwner}}">

<!-- En bas de list-detail.handlebars -->
{{> reservation-modal}}

<script>
// Fonction pour copier le lien de partage
function copyShareLink() {
    const shareLink = '{{baseUrl}}/lists/{{list.id}}';
    navigator.clipboard.writeText(shareLink).then(() => {
        const copyBtn = document.getElementById('copyShareBtn');
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check me-1"></i> Copi√© !';
        copyBtn.className = 'btn btn-success btn-sm';
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.className = 'btn btn-outline-secondary btn-sm';
        }, 2000);
    }).catch(err => {
        console.error('Erreur copie:', err);
        alert('Erreur lors de la copie du lien');
    });
}

// Formatage du prix
function formatPrice(value) {
    if (!value) return '';
    
    // Remplacer virgule par point pour le calcul
    const numericValue = parseFloat(value.toString().replace(',', '.'));
    
    if (!isNaN(numericValue) && numericValue >= 0) {
        // Arrondir √† 2 d√©cimales et formater avec virgule
        return (Math.round(numericValue * 100) / 100).toFixed(2).replace('.', ',');
    }
    return value; // Retourner la valeur originale si non num√©rique
}

// Code principal
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Script initialis√©');
    
    // GESTION DU PRIX - SIMPLIFI√âE
    const priceInput = document.getElementById('itemPrice');
    if (priceInput) {
        console.log('‚úÖ Champ prix trouv√©');
        
        // Formatage quand on quitte le champ
        priceInput.addEventListener('blur', function() {
            console.log('üìù Formatage prix:', this.value);
            this.value = formatPrice(this.value);
        });
        
        // Validation pendant la saisie
        priceInput.addEventListener('input', function(e) {
            // Permettre seulement chiffres et virgule
            this.value = this.value.replace(/[^\d,]/g, '');
            
            // Emp√™cher plus d'une virgule
            const commas = (this.value.match(/,/g) || []).length;
            if (commas > 1) {
                this.value = this.value.replace(/,+$/, '').slice(0, -1);
            }
        });
    }

    // GESTION DE L'EXTRACTION
    const extractBtn = document.getElementById('extractInfoBtn');
    const itemUrl = document.getElementById('itemUrl');
    
    if (extractBtn && itemUrl) {
        extractBtn.addEventListener('click', extractProductInfo);
        
        // Extraction automatique
        let extractTimeout;
        itemUrl.addEventListener('input', function() {
            clearTimeout(extractTimeout);
            const url = this.value.trim();
            if (url && isValidUrl(url)) {
                extractTimeout = setTimeout(extractProductInfo, 1500);
            }
        });
    }

    async function extractProductInfo() {
        const url = itemUrl.value.trim();
        console.log('üéØ Extraction pour URL:', url);
        
        if (!url || !isValidUrl(url)) {
            alert('Veuillez entrer une URL valide');
            return;
        }

        const extractionLoading = document.getElementById('extractionLoading');
        const extractionResult = document.getElementById('extractionResult');
        const extractBtn = document.getElementById('extractInfoBtn');

        // Affichage loading
        extractionLoading.classList.remove('d-none');
        extractionResult.classList.add('d-none');
        extractBtn.disabled = true;
        extractBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Extraction...';

        try {
            console.log('üì° Envoi requ√™te extraction...');
            const response = await fetch('/api/extract-product-info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });

            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const result = await response.json();
            console.log('üìä R√©sultat extraction COMPLET:', result);

            if (result.success) {
                // Remplir les champs
                if (result.title) {
                    document.getElementById('itemName').value = result.title;
                    document.getElementById('extractedTitle').textContent = result.title;
                    console.log('‚úÖ Titre rempli:', result.title);
                }
                
                if (result.price) {
                    console.log('üí∞ Prix √† traiter:', result.price, 'Type:', typeof result.price);
                    
                    // Formater le prix imm√©diatement
                    const formattedPrice = formatPrice(result.price);
                    console.log('üî¢ Prix format√©:', formattedPrice);
                    
                    document.getElementById('itemPrice').value = formattedPrice;
                    document.getElementById('extractedPrice').textContent = formattedPrice + ' ‚Ç¨';
                    console.log('‚úÖ Prix ins√©r√© dans le champ');
                } else {
                    console.log('‚ùå Aucun prix dans la r√©ponse');
                }
                
                if (result.description) {
                    document.getElementById('itemDescription').value = result.description;
                    document.getElementById('extractedDescription').textContent = result.description;
                    console.log('‚úÖ Description remplie');
                }
                
                if (result.image) {
                    document.getElementById('itemImage').value = result.image;
                    document.getElementById('extractedImage').src = result.image;
                    document.getElementById('extractedImage').style.display = 'block';
                    console.log('‚úÖ Image remplie');
                } else {
                    document.getElementById('extractedImage').style.display = 'none';
                }

                extractionResult.classList.remove('d-none');
                showNotification('‚úÖ Informations extraites avec succ√®s !', 'success');
                
            } else {
                console.log('‚ùå Extraction √©chou√©e:', result.error);
                showNotification('‚ùå ' + (result.error || 'Erreur extraction'), 'error');
            }

        } catch (error) {
            console.error('üí• Erreur extraction:', error);
            showNotification('‚ùå Erreur lors de l\'extraction', 'error');
        } finally {
            extractionLoading.classList.add('d-none');
            extractBtn.disabled = false;
            extractBtn.innerHTML = '<i class="fas fa-magic me-1"></i>Extraire';
        }
    }

    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    function showNotification(message, type) {
        const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) alertDiv.parentNode.removeChild(alertDiv);
        }, 5000);
    }

    // Copie du lien
    const copyBtn = document.getElementById('copyShareBtn');
    if (copyBtn) {
        copyBtn.addEventListener('click', copyShareLink);
    }

    // R√©initialisation du modal
    const addItemModal = document.getElementById('addItemModal');
    if (addItemModal) {
        addItemModal.addEventListener('hidden.bs.modal', function() {
            const form = document.getElementById('addItemForm');
            if (form) {
                form.reset();
                console.log('üîÑ Formulaire r√©initialis√©');
            }
            
            const extractionResult = document.getElementById('extractionResult');
            if (extractionResult) {
                extractionResult.classList.add('d-none');
                console.log('üîÑ R√©sultat extraction cach√©');
            }
        });
    }
});
</script>